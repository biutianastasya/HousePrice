{% extends 'layout.html' %} {% block content %}
<h1>Prediksi Harga Rumah Jabodetabek</h1>
{% if error %}
<div class="alert alert-danger">{{ error }}</div>
{% endif %}
<form method="POST" id="prediction-form" novalidate>
  <div class="row">
    <div class="col-md-6">
      <label for="luas_tanah">Luas Tanah (m²)</label>
      <input type="number" step="0.01" name="luas_tanah" id="luas_tanah" class="form-control" required min="1" />
      <div class="invalid-feedback">
        Mohon masukkan luas tanah yang valid (minimal 1 m²)
      </div>
    </div>
    <div class="col-md-6">
      <label for="luas_bangunan">Luas Bangunan (m²)</label>
      <input type="number" step="0.01" name="luas_bangunan" id="luas_bangunan" class="form-control" required min="1" />
      <div class="invalid-feedback">
        Mohon masukkan luas bangunan yang valid (minimal 1 m²)
      </div>
    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-4">
      <label for="tahun_dibangun">Tahun Dibangun</label>
      <input type="number" name="tahun_dibangun" id="tahun_dibangun" class="form-control" required min="1900"
        max="2025" />
      <div class="invalid-feedback">
        Masukkan tahun dibangun yang valid (1900-2025)
      </div>
    </div>
    <div class="col-md-4">
      <label for="tahun_direnovasi">Tahun Direnovasi</label>
      <input type="number" name="tahun_direnovasi" id="tahun_direnovasi" class="form-control" min="1900" max="2025" />
      <div class="invalid-feedback">
        Masukkan tahun renovasi yang valid (kosong jika belum direnovasi)
      </div>
    </div>
    <div class="col-md-4">
      <label for="lebar_jalan">Lebar Jalan (m)</label>
      <input type="number" name="lebar_jalan" id="lebar_jalan" class="form-control" required min="0" max="100" />
      <div class="invalid-feedback">
        Masukkan lebar jalan yang valid (1-100 meter)
      </div>
    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-4">
      <label for="air">Air</label>
      <select name="air" id="air" class="form-select" required>
        <option value="PAM">PAM</option>
        <option value="Sumur Pompa">Sumur Pompa</option>
      </select>
      <div class="invalid-feedback">Pilih sumber air</div>
    </div>
    <div class="col-md-4">
      <label for="keadaan_lingkungan">Keadaan Lingkungan</label>
      <select name="keadaan_lingkungan" id="keadaan_lingkungan" class="form-select" required>
        <option value="Kota">Kota</option>
        <option value="Pertokoan/Pasar">Pertokoan/Pasar</option>
        <option value="Perumahan/Pemukiman">Perumahan/Pemukiman</option>
      </select>
      <div class="invalid-feedback">Pilih keadaan lingkungan</div>
    </div>
    <div class="col-md-4">
      <label for="sarana_transportasi">Sarana Transportasi</label>
      <select name="sarana_transportasi" id="sarana_transportasi" class="form-select" required>
        <option value="Memadai">Memadai</option>
        <option value="Cukup Memadai">Cukup Memadai</option>
        <option value="Kurang Memadai">Kurang Memadai</option>
      </select>
      <div class="invalid-feedback">Pilih sarana transportasi</div>
    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-6">
      <label for="status_tanah">Status Tanah</label>
      <select name="status_tanah" id="status_tanah" class="form-select" required>
        <option value="-">-</option>
        <option value="SHM">SHM (Sertifikat Hak Milik)</option>
        <option value="SHGB">SHGB (Sertifikat Hak Guna Bangunan)</option>
        <option value="PPJB">PPJB (Perjanjian Pengikatan Jual Beli)</option>
        <option value="Lain-Lain:">Lain - Lain</option>
      </select>
      <div class="invalid-feedback">Pilih status tanah</div>
    </div>
    <div class="col-md-6">
      <label for="bentuk_bangunan">Bentuk Bangunan</label>
      <select name="bentuk_bangunan" id="bentuk_bangunan" class="form-select" required>
        <option value="Tidak Bertingkat">Tidak Bertingkat</option>
        <option value="Bertingkat">Bertingkat</option>
      </select>
      <div class="invalid-feedback">Pilih bentuk bangunan</div>
    </div>
  </div>

  <div class="row mt-2">
    <div class="col-md-4">
      <label for="kondisi_lingkungan_khusus">Kondisi Lingkungan Khusus</label>
      <select name="kondisi_lingkungan_khusus" id="kondisi_lingkungan_khusus" class="form-select" required>
        <option value="-">-</option>
        <option value="Bebas Banjir">Bebas Banjir</option>
        <option value="Banjir Musiman">Banjir Musiman</option>
        <option value="Dekat Tempat Ibadah">Dekat Tempat Ibadah</option>
        <option value="Dekat Tegangan Tinggi">Dekat Tegangan Tinggi</option>
      </select>
      <div class="invalid-feedback">Pilih kondisi lingkungan</div>
    </div>
    <div class="col-md-4">
      <label for="letak_persil">Letak Persil</label>
      <select name="letak_persil" id="letak_persil" class="form-select" required>
        <option value="Tengah">Tengah</option>
        <option value="Sudut/ Pojok">Sudut/Pojok</option>
        <option value="Pojok">Pojok</option>
        <option value="Tusuk Sate">Tusuk Sate</option>
        <option value="Tusuk sate sebagian">Tusuk Sate Sebagian</option>
        <option value="Hoek dan Tusuk Sate">Hook dan Tusuk Sate</option>
        <option value="Hoek">Hook</option>
      </select>
      <div class="invalid-feedback">Pilih letak persil</div>
    </div>
    <div class="col-md-4">
      <label for="lokasi_aset">Lokasi Aset</label>
      <select name="lokasi_aset" id="lokasi_aset" class="form-select" required>
        <option value="Tengah">Tengah</option>
        <option value="Belakang">Belakang</option>
        <option value="Depan">Depan</option>
      </select>
      <div class="invalid-feedback">Pilih lokasi aset</div>
    </div>
  </div>

  <div class="mt-3">
    <label class="d-block">Mode Lokasi:</label>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="mode" id="mode-maps" value="maps" checked />
      <label class="form-check-label" for="mode-maps">Peta</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="mode" id="mode-manual" value="manual" />
      <label class="form-check-label" for="mode-manual">Manual</label>
    </div>
  </div>

  <div class="mt-2" id="maps-container">
    <div class="mb-3">
      <label for="alamat">Alamat</label>
      <input type="text" name="alamat" id="alamat-input" class="form-control" placeholder="Masukkan alamat..."
        list="address-suggestions" autocomplete="off" required />
      <datalist id="address-suggestions"></datalist>
      <div class="invalid-feedback">Mohon masukkan alamat yang valid</div>
    </div>
    <div id="map" style="height: 400px" class="mb-3"></div>
  </div>

  <div class="row mt-2" id="manual-container" style="display: none">
    <div class="col-md-6">
      <label for="latitude">Latitude</label>
      <input type="text" name="lat" id="latitude" class="form-control" placeholder="-6.2088" />
      <div class="invalid-feedback">
        Latitude harus berupa angka (contoh: -6.2088)
      </div>
    </div>
    <div class="col-md-6">
      <label for="longitude">Longitude</label>
      <input type="text" name="lon" id="longitude" class="form-control" placeholder="106.8456" />
      <div class="invalid-feedback">
        Longitude harus berupa angka (contoh: 106.8456)
      </div>
    </div>
    <div class="col-md-6 mt-2">
      <label for="kota">Kota</label>
      <input type="text" name="kota" id="kota" class="form-control" placeholder="Jakarta Selatan" />
      <div class="invalid-feedback">Mohon masukkan nama kota</div>
    </div>
    <div class="col-md-6 mt-2">
      <label for="kode_pos">Kode Pos</label>
      <input type="text" name="kode_pos" id="kode_pos" class="form-control" placeholder="12345" />
      <div class="invalid-feedback">Mohon masukkan kode pos</div>
    </div>
  </div>

  <!-- Hidden fields for geocoding data -->
  <div style="display: none">
    <input type="hidden" name="hidden_lat" id="hidden-lat" />
    <input type="hidden" name="hidden_lon" id="hidden-lon" />
    <input type="hidden" name="hidden_kota" id="hidden-kota" />
    <input type="hidden" name="hidden_kode_pos" id="hidden-kode_pos" />
  </div>

  <button type="submit" class="btn btn-primary mt-4">Prediksi</button>
</form>

<script>
  // Jakarta center coordinates (Monas)
  const JAKARTA_CENTER = [-6.1754, 106.8272];

  // Function to calculate distance between two coordinates in km (Haversine formula)
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c; // Distance in km
  }

  // Function to update distance field
  function updateDistanceToJakarta(lat, lng) {
    const distance = calculateDistance(lat, lng, JAKARTA_CENTER[0], JAKARTA_CENTER[1]);
    document.getElementById('distance-to-jakarta').value = distance.toFixed(2);
    return distance;
  }

  // Inisialisasi peta
  var map = L.map("map").setView([-6.2, 106.816666], 11);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  var marker;

  // Store geocoding data
  window.markerAddressDetails = null;

  // Tambahkan kontrol untuk instruksi kepada user
  var info = L.control({ position: "topleft" });
  info.onAdd = function () {
    var div = L.DomUtil.create("div", "info");
    div.innerHTML =
      '<div class="alert alert-info p-2" style="opacity: 0.8;">Klik pada peta untuk menentukan lokasi atau ketik alamat di kolom isian</div>';
    return div;
  };
  info.addTo(map);

  let suggestionsData = [];
  const dataList = document.getElementById("address-suggestions");
  const addressInput = document.getElementById("alamat-input");
  const latitudeInput = document.getElementById("latitude");
  const longitudeInput = document.getElementById("longitude");

  // Toggle between maps and manual mode
  document.getElementById("mode-maps").addEventListener("change", function () {
    if (this.checked) {
      document.getElementById("maps-container").style.display = "block";
      document.getElementById("manual-container").style.display = "none";
      // Copy values from manual inputs if they exist
      if (latitudeInput.value && longitudeInput.value) {
        const lat = parseFloat(latitudeInput.value.replace(",", "."));
        const lng = parseFloat(longitudeInput.value.replace(",", "."));
        if (!isNaN(lat) && !isNaN(lng)) {
          if (marker) map.removeLayer(marker);
          marker = L.marker([lat, lng], { draggable: true }).addTo(map);
          map.setView([lat, lng], 14);
          reverseGeocode(lat, lng).then((data) => {
            if (data && data.display_name) {
              addressInput.value = data.display_name;
              window.markerAddressDetails = data;
            }
          });
        }
      }
      setTimeout(() => map.invalidateSize(), 100);
    }
  });

  document
    .getElementById("mode-manual")
    .addEventListener("change", function () {
      if (this.checked) {
        document.getElementById("maps-container").style.display = "none";
        document.getElementById("manual-container").style.display = "flex";
        // Copy values from map marker if it exists
        if (marker) {
          const position = marker.getLatLng();
          latitudeInput.value = position.lat.toFixed(6);
          longitudeInput.value = position.lng.toFixed(6);
        }
      }
    });

  // Function untuk melakukan reverse geocoding
  async function reverseGeocode(lat, lng) {
    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`,
        { headers: { "User-Agent": "RealEstateApp/1.0 (alifbiuti@gmail.com)" } }
      );
      const data = await response.json();
      window.markerAddressDetails = data;
      return data;
    } catch (error) {
      console.error("Error during reverse geocoding:", error);
      return null;
    }
  }

  // Event handler untuk klik peta
  map.on("click", async function (e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    // Hapus marker lama jika ada
    if (marker) {
      map.removeLayer(marker);
    }

    // Tambahkan marker baru yang bisa didrag
    marker = L.marker([lat, lng], { draggable: true }).addTo(map);

    // Update manual inputs
    latitudeInput.value = lat.toFixed(6);
    longitudeInput.value = lng.toFixed(6);

    // Dapatkan alamat dari koordinat
    const geoData = await reverseGeocode(lat, lng);
    if (geoData && geoData.display_name) {
      addressInput.value = geoData.display_name;
      window.markerAddressDetails = geoData; // Store the full geocoding response
    }

    updateDistanceToJakarta(newLat, newLng);

    // Event handler untuk marker yang didrag
    marker.on("dragend", async function (e) {
      const newLat = e.target.getLatLng().lat;
      const newLng = e.target.getLatLng().lng;

      // Update manual inputs
      latitudeInput.value = newLat.toFixed(6);
      longitudeInput.value = newLng.toFixed(6);

      // Dapatkan alamat dari koordinat baru
      const geoData = await reverseGeocode(newLat, newLng);
      if (geoData && geoData.display_name) {
        addressInput.value = geoData.display_name;
        window.markerAddressDetails = geoData; // Store the full geocoding response
      }

      updateDistanceToJakarta(newLat, newLng);
    });
  });

  // Autocomplete suggestions with debounce
  let timeout = null;
  addressInput.addEventListener("input", function () {
    const query = this.value;
    if (query.length < 3) {
      dataList.innerHTML = "";
      return;
    }

    // Clear any existing timeout
    if (timeout) {
      clearTimeout(timeout);
    }

    // Set a new timeout
    timeout = setTimeout(() => {
      fetch(
        `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(
          query
        )}`
      )
        .then((res) => res.json())
        .then((data) => {
          suggestionsData = data;
          dataList.innerHTML = "";
          data.forEach((item) => {
            const option = document.createElement("option");
            option.value = item.display_name;
            dataList.appendChild(option);
          });
        });
    }, 1000); // 1 second delay
  });

  // Saat user memilih alamat dari list
  addressInput.addEventListener("change", function () {
    const selected = this.value;
    const item = suggestionsData.find((d) => d.display_name === selected);
    if (item) {
      const lat = parseFloat(item.lat);
      const lon = parseFloat(item.lon);

      // Update manual inputs
      latitudeInput.value = lat.toFixed(6);
      longitudeInput.value = lon.toFixed(6);

      if (marker) map.removeLayer(marker);
      marker = L.marker([lat, lon], { draggable: true }).addTo(map);
      map.setView([lat, lon], 14);

      // Store the address data
      window.markerAddressDetails = item;

      // Add dragend event to the marker
      marker.on("dragend", async function (e) {
        const newLat = e.target.getLatLng().lat;
        const newLng = e.target.getLatLng().lng;

        // Update manual inputs
        latitudeInput.value = newLat.toFixed(6);
        longitudeInput.value = newLng.toFixed(6);

        // Get address from new coordinates
        const geoData = await reverseGeocode(newLat, newLng);
        if (geoData && geoData.display_name) {
          addressInput.value = geoData.display_name;
          window.markerAddressDetails = geoData; // Store the full geocoding response
        }
      });
    }

    updateDistanceToJakarta(lat, lng);
  });

  document
    .getElementById("prediction-form")
    .addEventListener("submit", async function (event) {
      const form = this;
      const isManualMode = document.getElementById("mode-manual").checked;
      let isValid = true;

      // Handle the required fields based on mode
      if (isManualMode) {
        // In manual mode, we need lat/lng
        const latValue = latitudeInput.value.replace(",", ".");
        const lngValue = longitudeInput.value.replace(",", ".");

        const lat = parseFloat(latValue);
        const lng = parseFloat(lngValue);

        if (!isNaN(lat) && !isNaN(lng)) {
          updateDistanceToJakarta(lat, lng);
        }

        if (isNaN(lat)) {
          latitudeInput.setCustomValidity("Latitude harus berupa angka");
          isValid = false;
        } else {
          latitudeInput.setCustomValidity("");
          // Keep the original lat/lon fields in manual mode
          document.getElementById("hidden-lat").value = lat;
        }

        if (isNaN(lng)) {
          longitudeInput.setCustomValidity("Longitude harus berupa angka");
          isValid = false;
        } else {
          longitudeInput.setCustomValidity("");
          document.getElementById("hidden-lon").value = lng;
        }

        // Use kota and kode_pos values from manual inputs - copy to hidden fields
        document.getElementById("hidden-kota").value =
          document.getElementById("kota").value || "Jakarta";
        document.getElementById("hidden-kode_pos").value =
          document.getElementById("kode_pos").value || "";
      } else {
        // Maps mode - use hidden fields and disable manual inputs
        if (!addressInput.value.trim()) {
          addressInput.setCustomValidity(
            "Mohon masukkan alamat atau klik pada peta"
          );
          isValid = false;
        } else {
          addressInput.setCustomValidity("");
        }

        // Disable manual fields so they aren't submitted
        document.getElementById("latitude").disabled = true;
        document.getElementById("longitude").disabled = true;
        document.getElementById("kota").disabled = true;
        document.getElementById("kode_pos").disabled = true;

        // Get geocoding data from the marker
        if (marker) {
          const position = marker.getLatLng();
          document.getElementById("hidden-lat").value = position.lat;
          document.getElementById("hidden-lon").value = position.lng;

          // Before submitting, ensure we have city and postal code from marker
          if (!window.markerAddressDetails) {
            // If we don't have the details yet, fetch them
            event.preventDefault(); // Prevent form submission

            try {
              const geoData = await reverseGeocode(position.lat, position.lng);
              if (geoData) {
                window.markerAddressDetails = geoData;
                // Store city and postal code
                let city = "Jakarta"; // Default
                let postalCode = "";

                if (geoData.address) {
                  // Try to get city from address components
                  for (const cityKey of [
                    "city",
                    "town",
                    "municipality",
                    "state",
                  ]) {
                    if (geoData.address[cityKey]) {
                      city = geoData.address[cityKey];
                      break;
                    }
                  }

                  if (geoData.address.postcode) {
                    postalCode = geoData.address.postcode;
                  }
                }

                // Store values in hidden fields
                document.getElementById("hidden-kota").value = city;
                document.getElementById("hidden-kode_pos").value = postalCode;

                // Now submit the form
                form.submit();
              }
            } catch (error) {
              console.error("Error fetching address details:", error);
              // Still allow form submission even if geocoding fails
              document.getElementById("hidden-kota").value = "Jakarta";
              document.getElementById("hidden-kode_pos").value = "";
              form.submit();
            }
            return false;
          } else {
            // We already have the address details
            let city = "Jakarta"; // Default
            let postalCode = "";

            if (window.markerAddressDetails.address) {
              // Try to get city from address components
              for (const cityKey of ["city", "town", "municipality", "state"]) {
                if (window.markerAddressDetails.address[cityKey]) {
                  city = window.markerAddressDetails.address[cityKey];
                  break;
                }
              }

              if (window.markerAddressDetails.address.postcode) {
                postalCode = window.markerAddressDetails.address.postcode;
              }
            }

            // Store values in hidden fields
            document.getElementById("hidden-kota").value = city;
            document.getElementById("hidden-kode_pos").value = postalCode;
          }
        } else {
          // No marker, use default values
          document.getElementById("hidden-lat").value = -6.2;
          document.getElementById("hidden-lon").value = 106.816666;
          document.getElementById("hidden-kota").value = "Jakarta";
          document.getElementById("hidden-kode_pos").value = "";
        }
      }

      // Additional custom validation
      const tahunDibangun = parseInt(
        document.getElementById("tahun_dibangun").value
      );
      const tahunDirenovasi = document.getElementById("tahun_direnovasi").value;

      if (tahunDirenovasi && parseInt(tahunDirenovasi) < tahunDibangun) {
        document
          .getElementById("tahun_direnovasi")
          .setCustomValidity(
            "Tahun renovasi harus lebih besar dari tahun dibangun"
          );
        isValid = false;
      } else {
        document.getElementById("tahun_direnovasi").setCustomValidity("");
      }

      // Add validation class to show feedback
      form.classList.add("was-validated");

      if (!isValid) {
        event.preventDefault();
        return false;
      }
    });

  // Set default value for tahun dibangun to current year
  document.getElementById("tahun_dibangun").value = new Date().getFullYear();
</script>
{% endblock %}